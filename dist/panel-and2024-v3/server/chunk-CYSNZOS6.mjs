import './polyfills.server.mjs';
import{$ as G}from"./chunk-KMWCCYID.mjs";import{ab as A,u as B}from"./chunk-F3VCI4QE.mjs";import{$ as j,G as m,T as f,ca as N,o as c,q as u,r as p}from"./chunk-WNM5W7LL.mjs";import{a as h,h as C}from"./chunk-H6KHSOBK.mjs";var g=C(G());var I=C(G());var z=(()=>{let y=class y{constructor(n,i){this.afs=n,this.message=i}getBoardingPassesByRoute(n){let i=new Date;return this.joined$=this.afs.collectionGroup("routesAccess",r=>r.where("active","==",!0)).valueChanges().pipe(m(1),f(r=>{let o=(0,I.uniq)(r.map(s=>s.routeId));return o.length===0?c([]):p(c(r),p(o.map(s=>this.afs.collectionGroup("boardingPasses",t=>t.where("routeId","==",s)).snapshotChanges().pipe(u(t=>t.map(e=>{let a=e.payload.doc.id,d=e.payload.doc.data(),l=e.payload.doc.ref.parent.parent.id;return h({id:a,uid:l},d)}))))))}),u(([r,o])=>{let s=o.filter(t=>!!t&&t.length>0);return typeof s<"u"?s.map(t=>{let e=g.filter(r,a=>t[0].routeId===a.routeId);return{passes:[...t],permission:e[0].active?e[0].active:!1,permissionId:e[0].id,customerId:e[0].customerId||"",routeName:e[0].routeName||"",customerName:e[0].customerName||""}}):c([])})),this.joined$}getBoardingPassesByProduct(n){let i=new Date;return this.joined$=this.afs.collectionGroup("routesAccess",r=>r.where("active","==",!0)).valueChanges().pipe(m(1),f(r=>{let o=(0,I.uniq)(r.map(s=>s.routeId));return o.length===0?c([]):p(c(r),p(o.map(s=>this.afs.collectionGroup("boardingPasses",t=>t.where("routeId","==",s).where("product_id","==",n)).snapshotChanges().pipe(u(t=>t.map(e=>{let a=e.payload.doc.id,d=e.payload.doc.data(),l=e.payload.doc.ref.parent.parent.id;return h({id:a,uid:l},d)}))))))}),u(([r,o])=>{let s=o.filter(t=>!!t&&t.length>0);return typeof s<"u"?s.map(t=>{let e=g.filter(r,a=>t[0].routeId===a.routeId);return{passes:[...t],permission:e[0].active?e[0].active:!1,permissionId:e[0].id,customerId:e[0].customerId||"",routeName:e[0].routeName||"",customerName:e[0].customerName||""}}):c([])})),this.joined$}getBoardingPassesByTurn(n,i){let r=new Date;return this.joined$=this.afs.collectionGroup("routesAccess",o=>o.where("active","==",!0)).valueChanges().pipe(m(1),f(o=>{let s=(0,I.uniq)(o.map(t=>t.routeId));return s.length===0?c([]):p(c(o),p(s.map(t=>this.afs.collectionGroup("boardingPasses",e=>e.where("routeId","==",t).where("round","==",i).where("product_id","==",n)).snapshotChanges().pipe(u(e=>e.map(a=>{let d=a.payload.doc.id,l=a.payload.doc.data(),v=a.payload.doc.ref.parent.parent.id;return h({id:d,uid:v},l)}))))))}),u(([o,s])=>{let t=s.filter(e=>!!e&&e.length>0);return typeof t<"u"?t.map(e=>{let a=g.filter(o,d=>e[0].routeId===d.routeId);return{passes:[...e],permission:a[0].active?a[0].active:!1,permissionId:a[0].id,customerId:a[0].customerId||"",routeName:a[0].routeName||"",customerName:a[0].customerName||""}}):c([])})),this.joined$}getBoardingPassesByAnticipos(n){let i=new Date;return this.joined$=this.afs.collectionGroup("routesAccess",r=>r.where("active","==",!0)).valueChanges().pipe(m(1),f(r=>{let o=(0,I.uniq)(r.map(s=>s.routeId));return o.length===0?c([]):p(c(r),p(o.map(s=>this.afs.collectionGroup("boardingPasses",t=>t.where("routeId","==",s).where("product_id","==",n).where("payment","==","Anticipo")).snapshotChanges().pipe(u(t=>t.map(e=>{let a=e.payload.doc.id,d=e.payload.doc.data(),l=e.payload.doc.ref.parent.parent.id;return h({id:a,uid:l},d)}))))))}),u(([r,o])=>{let s=o.filter(t=>!!t&&t.length>0);return typeof s<"u"?s.map(t=>{let e=g.filter(r,a=>t[0].routeId===a.routeId);return{passes:[...t],permission:e[0].active?e[0].active:!1,permissionId:e[0].id,customerId:e[0].customerId||"",routeName:e[0].routeName||"",customerName:e[0].customerName||""}}):c([])})),this.joined$}getBoardingPassRoutes(){return this.afs.collectionGroup("routesAccess",i=>i.where("active","==",!0)).snapshotChanges()}getBoardingPassRoute(n){let i=new Date;return this.joined$=this.afs.collectionGroup("routesAccess",r=>r.where("active","==",!0)).valueChanges().pipe(m(1),f(r=>{let o=(0,I.uniq)(r.map(s=>s.routeId));return o.length===0?c([]):p(c(r),p(o.map(s=>this.afs.collectionGroup("boardingPasses",t=>t.where("routeId","==",s).where("product_id","==",n).where("payment","==","Anticipo").where("baja","==","").where("promiseDate","<=",new Date)).snapshotChanges().pipe(u(t=>t.map(e=>{let a=e.payload.doc.id,d=e.payload.doc.data(),l=e.payload.doc.ref.parent.parent.id;return h({id:a,uid:l},d)}))))))}),u(([r,o])=>{let s=o.filter(t=>!!t&&t.length>0);return console.log("boarding pasess"),console.log(o),typeof s<"u"?s.map(t=>{let e=g.filter(r,a=>t[0].routeId===a.routeId);return{routeName:e[0].routeName||"",routeId:e[0].routeId||""}}):c([])})),this.joined$}getBoardingPassBySingleRoute(n,i){console.log(n+" / "+i);let r=new Date;return this.joined$=this.afs.collectionGroup("routesAccess",o=>o.where("active","==",!0).where("routeId","==",i)).valueChanges().pipe(m(1),f(o=>{let s=(0,I.uniq)(o.map(t=>t.routeId));return s.length===0?c([]):p(c(o),p(s.map(t=>this.afs.collectionGroup("boardingPasses",e=>e.where("routeId","==",t).where("product_id","==",n).where("payment","==","Anticipo").where("baja","==","").where("promiseDate","<=",new Date)).snapshotChanges().pipe(u(e=>e.map(a=>{let d=a.payload.doc.id,l=a.payload.doc.data(),v=a.payload.doc.ref.parent.parent.id;return h({id:d,uid:v},l)}))))))}),u(([o,s])=>{let t=s.filter(e=>!!e&&e.length>0);return typeof t<"u"?t.map(e=>{let a=g.filter(o,d=>e[0].routeId===d.routeId);return{passes:[...e],permission:a[0].active?a[0].active:!1,permissionId:a[0].id,customerId:a[0].customerId||"",routeName:a[0].routeName||"",customerName:a[0].customerName||""}}):c([])})),this.joined$}getBoardingPassesByCV(n){let i=new Date;return this.joined$=this.afs.collectionGroup("routesAccess",r=>r.where("active","==",!0)).valueChanges().pipe(m(1),f(r=>{let o=(0,I.uniq)(r.map(s=>s.routeId));return o.length===0?c([]):p(c(r),p(o.map(s=>this.afs.collectionGroup("boardingPasses",t=>t.where("routeId","==",s).where("product_id","==",n).where("payment","==","Anticipo").where("baja","==","").where("promiseDate","<=",new Date)).snapshotChanges().pipe(u(t=>t.map(e=>{let a=e.payload.doc.id,d=e.payload.doc.data(),l=e.payload.doc.ref.parent.parent.id;return h({id:a,uid:l},d)}))))))}),u(([r,o])=>{console.log("boarding pasess"),console.log(o);let s=o.filter(t=>!!t&&t.length>0);return typeof s<"u"?s.map(t=>{let e=g.filter(r,a=>t[0].routeId===a.routeId);return{passes:[...t],permission:e[0].active?e[0].active:!1,permissionId:e[0].id,customerId:e[0].customerId||"",routeName:e[0].routeName||"",customerName:e[0].customerName||""}}):c([])})),this.joined$}getBoardingPassActivityLog(n,i){return this.afs.collection("users").doc(n).collection("boardingPasses").doc(i).collection("activityLog",o=>o.orderBy("created")).snapshotChanges()}getLastValidBoardingPass(n){return this.afs.collection("users").doc(n).collection("boardingPasses").stateChanges().pipe(m(1),u(r=>r.map(o=>{let s=o.payload.doc.id,t=o.payload.doc.data();return h({id:s},t)})))}updateUserAvatar(n,i){this.afs.collection("users").doc(n).update({photoURL:i}).then(()=>{}).catch(o=>{this.message.error("Hubo un error: ",o),console.log(o)})}updateUserPreRegister(n,i){let r=this.afs.collection("users").doc(n);console.log("toChange "+n+" to status  "+i),r.update({status:i}).then(()=>{}).catch(o=>{this.message.error("Hubo un error: ",o),console.log(o)})}updateUserCollection(n,i){return this.user=this.afs.collection("users").doc(n),this.user.update(i).then(()=>{}).catch(r=>{this.message.error(`\xA1Oops! Algo sali\xF3 mal ... ${r}`)})}getUserInfo(n){return this.afs.collection("users").doc(n).snapshotChanges()}getUserInfoByEmail(n){return this.afs.collection("users",r=>r.where("email","==",n)).snapshotChanges()}};y.\u0275fac=function(i){return new(i||y)(N(B),N(A))},y.\u0275prov=j({token:y,factory:y.\u0275fac,providedIn:"root"});let w=y;return w})();export{z as a};
